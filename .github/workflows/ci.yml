# CI pipeline for validating code on pushes and pull requests to main/master
# Ensures consistent quality checks before merging
name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

# ---------------------------------------------------------
# Security scanning job (runs once, outside the Node matrix)
# ---------------------------------------------------------
gitleaks:
  name: Secret Scan (Gitleaks)
  runs-on: ubuntu-latest

  steps:
    # Pull repository contents into the runner
    # fetch-depth: 0 ensures full history is available for PR diff scanning
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Run Gitleaks using the official action
    # GITHUB_TOKEN is required for PR scanning as of Gitleaks Action v2
    - name: Scan for secrets with Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# ---------------------------------------------------------
# Build + Test job (runs for each Node version in the matrix)
# Depends on Gitleaks to ensure security checks pass first
# ---------------------------------------------------------
jobs:
  build-and-test:
    needs: gitleaks
    # Use GitHubâ€™s Ubuntu runner (ephemeral VM)
    runs-on: ubuntu-latest

    strategy:
      # Test across all active Node LTS versions to catch version-specific issues
      matrix:
        node-version: [20.x, 22.x, 24.x]

    steps:
      # Pull repository contents into the runner
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install the correct Node version for this matrix job
      # Enable npm caching based on package-lock.json hash for faster installs
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache:
